<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/carrito.css">
    <link rel="stylesheet" href="/css/animations.css">
    <title>ðŸ›’ PetShop Innovador - Carrito de Compras</title>
</head>
<body>
    <%- include('partials/header', { page: 'carrito' }) %>

    <main class="carrito-container">
        <div class="carrito-header animate-fadeInUp">
            <div class="back-button">
                <a href="/" class="btn-back">
                    <i class="fas fa-arrow-left"></i>
                    Seguir Comprando
                </a>
            </div>
            <h1><i class="fas fa-shopping-cart"></i> Mi Carrito de Compras</h1>
        </div>

        <% if (carrito && carrito.length > 0) { %>
            <div class="carrito-content animate-fadeInUp delay-1">
                <div class="carrito-items">
                    <% carrito.forEach((item, index) => { %>
                        <div class="carrito-item animate-fadeInLeft delay-<%= (index % 3) + 1 %>" data-product-id="<%= item.id %>">
                            <div class="item-image">
                                <img src="/images/products/<%= item.imagen || item.img || 'default.jpg' %>" alt="<%= item.nombre %>" loading="lazy" decoding="async" width="120" height="90" onerror="this.src='/images/logo_petshop.jpeg'" />
                            </div>
                            <div class="item-details">
                                <h3><%= item.nombre %></h3>
                                <p class="item-price">$<%= item.precio %></p>
                            </div>
                            <div class="item-quantity">
                                <form action="/carrito/update/<%= item.id %>?_method=PUT" method="POST" class="quantity-form">
                                    <label for="cantidad-<%= item.id %>">Cantidad:</label>
                                    <div class="quantity-controls">
                                        <button type="button" class="qty-btn btn-decrease" data-id="<%= item.id %>">
                                            <i class="fas fa-minus" aria-hidden="true"></i>
                                        </button>
                         <input type="number" 
                             id="cantidad-<%= item.id %>" 
                             name="cantidad" 
                             value="<%= item.cantidad %>" 
                             min="1" 
                             max="10"
                             data-precio="<%= item.precio %>"
                             class="qty-input"
                             data-id="<%= item.id %>">
                                        <button type="button" class="qty-btn btn-increase" data-id="<%= item.id %>">
                                            <i class="fas fa-plus" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="item-total">
                                <p id="subtotal-<%= item.id %>" class="subtotal">$<%= (parseFloat(item.precio) * item.cantidad).toFixed(2) %></p>
                            </div>
                            <div class="item-actions">
                                <form action="/carrito/remove/<%= item.id %>?_method=DELETE" method="POST" class="remove-form">
                                    <button type="submit" class="btn-remove">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                </div>

                <div class="carrito-summary animate-fadeInRight delay-2">
                    <div class="summary-card">
                        <h3><i class="fas fa-calculator"></i> Resumen del Pedido</h3>
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>$<%= total %></span>
                        </div>
                        <div class="summary-row">
                            <span>EnvÃ­o:</span>
                            <span class="free-shipping">GRATIS</span>
                        </div>
                        <div class="summary-row total-row">
                            <span>Total:</span>
                            <span class="total-amount">$<%= total %></span>
                        </div>
                        
                        <div class="checkout-actions">
                            <% if (locals.isLoggedIn) { %>
                                <a href="/checkout" class="btn-checkout">
                                    <i class="fas fa-credit-card"></i>
                                    Proceder al Pago
                                </a>
                            <% } else { %>
                                <a href="/users/login" class="btn-login">
                                    <i class="fas fa-user"></i>
                                    Iniciar SesiÃ³n para Continuar
                                </a>
                            <% } %>
                            
                            <form action="/carrito/clear" method="POST" class="clear-cart-form">
                                <button type="submit" class="btn-clear">
                                    <i class="fas fa-trash-alt"></i>
                                    Vaciar Carrito
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <div class="carrito-empty animate-bounceIn">
                <div class="empty-state">
                    <i class="fas fa-shopping-cart empty-icon"></i>
                    <h2>Tu carrito estÃ¡ vacÃ­o</h2>
                    <p>Â¡Descubre nuestros increÃ­bles productos para tu mascota!</p>
                    <a href="/" class="btn-shop">
                        <i class="fas fa-paw"></i>
                        Comenzar a Comprar
                    </a>
                </div>
            </div>
        <% } %>
    </main>

    <%- include('partials/footer') %>
    
    <script src="/js/petshop-animations.js" defer></script>
    
    <script>
    function recalcularTotal() {
        let total = 0;
        const items = document.querySelectorAll('.carrito-item');
        
        items.forEach(item => {
            const cantidadInput = item.querySelector('input[type="number"]');
            const precio = parseFloat(cantidadInput.dataset.precio || 0);
            const cantidad = parseInt(cantidadInput.value || 0);
            total += precio * cantidad;
        });
        
        const totalElement = document.querySelector('.total-amount');
        if (totalElement) {
            totalElement.textContent = `$${total.toFixed(2)}`;
        }
        
        const subtotalSummary = document.querySelector('.summary-row:first-child span:last-child');
        if (subtotalSummary) {
            subtotalSummary.textContent = `$${total.toFixed(2)}`;
        }
        
        return total;
    }

    function increaseQuantity(productId) {
        const input = document.getElementById(`cantidad-${productId}`);
        if (!input) return;
        
        const currentValue = parseInt(input.value) || 1;
        const maxValue = parseInt(input.max) || 10;
        
        if (currentValue < maxValue) {
            input.value = currentValue + 1;
            
            const precio = parseFloat(input.dataset.precio || 0);
            const subtotalElement = document.querySelector(`#subtotal-${productId}`);
            if (subtotalElement) {
                subtotalElement.textContent = `$${(precio * (currentValue + 1)).toFixed(2)}`;
            }
            
            recalcularTotal();
        }
    }

    function decreaseQuantity(productId) {
        const input = document.getElementById(`cantidad-${productId}`);
        if (!input) return;
        
        const currentValue = parseInt(input.value) || 1;
        
        if (currentValue > 1) {
            input.value = currentValue - 1;
            
            const precio = parseFloat(input.dataset.precio || 0);
            const subtotalElement = document.querySelector(`#subtotal-${productId}`);
            if (subtotalElement) {
                subtotalElement.textContent = `$${(precio * (currentValue - 1)).toFixed(2)}`;
            }
            
            recalcularTotal();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!document.querySelector('.carrito-item')) return;
        
        document.querySelectorAll('.btn-decrease').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.dataset.id;
                decreaseQuantity(productId);
            });
        });

        document.querySelectorAll('.btn-increase').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.dataset.id;
                increaseQuantity(productId);
            });
        });
        
        document.querySelectorAll('input[type="number"][id^="cantidad-"]').forEach(input => {
            input.addEventListener('change', function() {
                const productId = this.id.replace('cantidad-', '');
                const newValue = parseInt(this.value) || 1;
                
                if (newValue < 1) {
                    this.value = 1;
                    return;
                }
                if (newValue > 10) {
                    this.value = 10;
                    return;
                }
                
                const precio = parseFloat(this.dataset.precio || 0);
                const subtotalElement = document.querySelector(`#subtotal-${productId}`);
                if (subtotalElement) {
                    subtotalElement.textContent = `$${(precio * newValue).toFixed(2)}`;
                }
                
                recalcularTotal();
            });
        });
    });
    </script>

</body>
</html>